<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The MasterDank Collections ‚Äî Track Search</title>
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(120deg, #0a0f2c, #001f3f, #170f2e);
      background-size: 400% 400%;
      animation: bgShift 30s ease infinite;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    @keyframes bgShift {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }
    header {
      padding: 1.5rem;
      font-size: 1.6rem;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 2px solid #0ff;
      text-shadow: 0 0 8px #0ff;
    }
    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0,255,255,0.2);
    }
    input, select, button {
      font-family: 'Orbitron', sans-serif;
      font-size: 1rem;
      padding: 0.5rem;
      border: none;
      border-radius: 6px;
      margin: 0.3rem;
      color: #fff;
      background: rgba(0,0,0,0.6);
      outline: none;
    }
    button {
      background: #00ffff;
      color: #000;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    button:hover {
      background: #00b3b3;
    }
    table {
      margin: 1rem auto;
      border-collapse: collapse;
      width: 100%;
      color: #fff;
      display: none;
    }
    th, td {
      border: 1px solid rgba(255,255,255,0.1);
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background: rgba(0,255,255,0.1);
    }
    #status {
      margin-top: 1rem;
      color: #f66;
      font-size: 0.9rem;
    }
    footer {
      font-size: 0.8rem;
      color: #aaa;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <header>üß† The MasterDank Collections ‚Äî <span style="color:#00ffaa;">Track Search</span></header>

  <div class="container">
    <div>
      <input type="text" id="query" placeholder="Search by track or artist..." size="40">
      <select id="personFilter"><option value="">All bringers</option></select>
      <select id="partyFilter"><option value="">All sessions</option></select>
      <select id="sortBy">
        <option value="file_name.asc">Sort: Name ‚Üë</option>
        <option value="file_name.desc">Sort: Name ‚Üì</option>
        <option value="artist_norm.asc">Sort: Artist ‚Üë</option>
        <option value="artist_norm.desc">Sort: Artist ‚Üì</option>
        <option value="party_name.asc">Sort: Session ‚Üë</option>
        <option value="party_name.desc">Sort: Session ‚Üì</option>
      </select>
      <button onclick="searchTracks()">Search</button>
      <button onclick="exportCSV()">Export CSV</button>
    </div>
    <div id="status"></div>

    <table id="results">
      <thead>
        <tr>
          <th>Track</th>
          <th>Artist</th>
          <th>Sessions</th>
          <th>Brought by</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <footer>‚ú® Powered by Supabase ‚Äî handcrafted by The MasterDank Crew ‚ú®</footer>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabaseUrl = 'https://ilvfgrahrejymvnyrrxa.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdmZncmFocmVqeW12bnlycnhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODY4MzgsImV4cCI6MjA3NjE2MjgzOH0.BF9-ohNBCXhJUBvC0t6rtI8V9LcmL7PbfSKt_M4Mu0s'; // replace with anon key
    const supabase = createClient(supabaseUrl, supabaseKey);

    let lastResults = [];

    async function loadFilters() {
      const { data: persons } = await supabase.from('tracks_v2').select('person_raw').not('person_raw', 'is', null);
      const { data: parties } = await supabase.from('tracks_v2').select('party_name').not('party_name', 'is', null);

      const personSet = new Set(persons?.map(p => p.person_raw).filter(Boolean));
      const partySet = new Set(parties?.map(p => p.party_name).filter(Boolean));

      const personSelect = document.getElementById('personFilter');
      const partySelect = document.getElementById('partyFilter');

      for (const val of [...personSet].sort()) {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        personSelect.appendChild(opt);
      }

      for (const val of [...partySet].sort()) {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        partySelect.appendChild(opt);
      }
    }

    async function searchTracks() {
      const query = document.getElementById('query').value.trim();
      const person = document.getElementById('personFilter').value;
      const party = document.getElementById('partyFilter').value;
      const sortBy = document.getElementById('sortBy').value;
      const status = document.getElementById('status');
      const table = document.getElementById('results');
      const tbody = table.querySelector('tbody');

      tbody.innerHTML = '';
      table.style.display = 'none';
      status.textContent = 'üîç Searching...';
      status.style.color = '#fff';

      try {
        let q = supabase.from('tracks_v2').select('file_name, artist_norm, title_norm, person_raw, party_name');
        const filters = [];

        if (query) filters.push(`artist_norm.ilike.%${query}%`, `title_norm.ilike.%${query}%`, `file_name.ilike.%${query}%`);
        if (person) q = q.eq('person_raw', person);
        if (party) q = q.eq('party_name', party);

        if (filters.length) q = q.or(filters.join(','));

        const [col, dir] = sortBy.split('.');
        q = q.order(col, { ascending: dir === 'asc' });
        q = q.limit(200);

        const { data, error } = await q;
        if (error) throw error;

        if (!data || data.length === 0) {
          status.textContent = 'No results found.';
          return;
        }

        lastResults = data;

        const grouped = {};
        for (const row of data) {
          const key = row.file_name.toLowerCase();
          if (!grouped[key]) {
            grouped[key] = {
              track: row.title_norm || row.file_name,
              artist: row.artist_norm || (row.file_name.split('-')[0] || 'Unknown'),
              sessions: new Set(),
              people: new Set()
            };
          }
          grouped[key].sessions.add(row.party_name);
          grouped[key].people.add(row.person_raw);
        }

        for (const key in grouped) {
          const g = grouped[key];
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${g.track}</td>
            <td>${g.artist}</td>
            <td>${Array.from(g.sessions).join('<br>')}</td>
            <td>${Array.from(g.people).join('<br>')}</td>
          `;
          tbody.appendChild(tr);
        }

        table.style.display = 'table';
        status.style.color = '#0f0';
        status.textContent = `üé∂ Found ${data.length} results.`;
      } catch (err) {
        console.error('Search error:', err);
        status.textContent = 'Error performing search.';
        status.style.color = '#f66';
      }
    }

    function exportCSV() {
      if (!lastResults.length) {
        alert('No data to export.');
        return;
      }

      const header = ['file_name', 'artist_norm', 'title_norm', 'person_raw', 'party_name'];
      const csvRows = [header.join(';')];

      for (const row of lastResults) {
        csvRows.push(header.map(h => `"${(row[h] || '').replace(/"/g, '""')}"`).join(';'));
      }

      const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `MasterDank_Export_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    loadFilters();
    window.searchTracks = searchTracks;
    window.exportCSV = exportCSV;
  </script>
</body>
</html>

