<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Psy Sessions ‚Äî Supabase Explorer</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
  :root{--bg:#0f1220;--fg:#e7e9ee;--muted:#9aa0b4;--card:#171a2b;--accent:#7ae0ff}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  h1{font-size:20px;margin:0 0 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  select,input,button{background:#1f2540;color:var(--fg);border:1px solid #2a3054;border-radius:10px;padding:10px 12px;font:inherit}
  select{min-width:300px}
  button{cursor:pointer}
  .card{background:var(--card);border:1px solid #222746;border-radius:16px;padding:14px}
  #chart{height:480px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid #222746}
  th{position:sticky;top:0;background:#1b1f35}
  tr:hover td{background:#191d31}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#1f2540;border:1px solid #2a3054;color:#b8bfd8;font-size:12px}
  .footer{margin-top:14px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>üéõÔ∏è Psy Sessions ‚Äî Live Explorer</h1>
  <div class="row">
    <label for="viewSel">View</label>
    <select id="viewSel">
      <option value="view_top_artists">view_top_artists</option>
      <option value="view_ritual_tracks">view_ritual_tracks</option>
      <option value="view_shared_taste">view_shared_taste</option>
      <option value="view_personal_variety">view_personal_variety</option>
      <option value="view_evolution_by_year">view_evolution_by_year</option>
      <option value="view_cycle_comparison">view_cycle_comparison</option>
      <option value="view_influence_summary">view_influence_summary</option>
      <option value="view_influence_edges">view_influence_edges</option>
      <option value="view_collision_summary">view_collision_summary</option>
      <option value="view_same_party_collisions">view_same_party_collisions</option>
    </select>

    <label for="searchBox">Search</label>
    <input id="searchBox" type="search" placeholder="filter table (client-side)"/>
    <button id="refreshBtn">Refresh</button>
    <span class="pill" id="rowCount">0 rows</span>
  </div>

  <div class="card" id="chart"></div>

  <div class="card">
    <div class="muted" id="schemaNote"></div>
    <div style="overflow:auto;max-height:420px;margin-top:10px">
      <table id="dataTable">
        <thead></thead><tbody></tbody>
      </table>
    </div>
    <div class="footer" id="foot"></div>
  </div>
</div>

<script>
/* ====== CONFIG: your Supabase project (read-only via anon key) ====== */
const SUPABASE_URL = "https://ilvfgrahrejymvnyrrxa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdmZncmFocmVqeW12bnlycnhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODY4MzgsImV4cCI6MjA3NjE2MjgzOH0.BF9-ohNBCXhJUBvC0t6rtI8V9LcmL7PbfSKt_M4Mu0s";

/* ====== Basics ====== */
const viewSel = document.getElementById('viewSel');
const refreshBtn = document.getElementById('refreshBtn');
const tbl = document.getElementById('dataTable');
const thead = tbl.querySelector('thead');
const tbody = tbl.querySelector('tbody');
const chartDiv = document.getElementById('chart');
const searchBox = document.getElementById('searchBox');
const rowCount = document.getElementById('rowCount');
const schemaNote = document.getElementById('schemaNote');
const foot = document.getElementById('foot');

let rawRows = [];

/* ====== Supabase REST fetch (paged) ====== */
async function fetchAll(table) {
  const rows = [];
  const base = `${SUPABASE_URL}/rest/v1/${encodeURIComponent(table)}`;
  let from = 0, step = 1000, more = true;

  while (more) {
    const to = from + step - 1;
    const url = `${base}?select=*&order=1&id=not.is.null`; // order hack for stable pagination
    const res = await fetch(url, {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        Range: `${from}-${to}`,
        Prefer: 'count=estimated'
      }
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`HTTP ${res.status}: ${txt}`);
    }
    const chunk = await res.json();
    rows.push(...chunk);
    more = chunk.length === step;
    from += step;
  }
  return rows;
}

/* ====== Table rendering ====== */
function renderTable(rows) {
  if (!rows || !rows.length) {
    thead.innerHTML = "<tr><th>No data</th></tr>";
    tbody.innerHTML = "";
    rowCount.textContent = "0 rows";
    return;
  }
  const cols = Object.keys(rows[0]);
  thead.innerHTML = "<tr>" + cols.map(c => `<th data-col="${c}">${c}</th>`).join("") + "</tr>";
  tbody.innerHTML = rows.map(r => {
    return "<tr>" + cols.map(c => `<td>${escapeCell(r[c])}</td>`).join("") + "</tr>";
  }).join("");
  rowCount.textContent = `${rows.length} rows`;

  // sort on header click
  [...thead.querySelectorAll('th')].forEach(th => {
    th.onclick = () => {
      const col = th.dataset.col;
      const isNum = rows.every(x => x[col] === null || typeof x[col] === 'number');
      const current = th.dataset.dir === 'asc' ? 'desc' : 'asc';
      thead.querySelectorAll('th').forEach(t => t.removeAttribute('data-dir'));
      th.setAttribute('data-dir', current);
      rawRows.sort((a,b) => {
        const A = a[col], B = b[col];
        if (A == null && B == null) return 0;
        if (A == null) return 1;
        if (B == null) return -1;
        return isNum
          ? (current === 'asc' ? A - B : B - A)
          : (current === 'asc' ? String(A).localeCompare(String(B)) : String(B).localeCompare(String(A)));
      });
      renderTable(filteredRows()); // re-render with filter applied
    };
  });
}

function escapeCell(v) {
  if (v == null) return "";
  if (typeof v === 'object') return JSON.stringify(v);
  return String(v)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* ====== Filtering ====== */
function filteredRows() {
  const q = searchBox.value.trim().toLowerCase();
  if (!q) return rawRows;
  return rawRows.filter(row => {
    return Object.values(row).some(v => (v != null && String(v).toLowerCase().includes(q)));
  });
}
searchBox.addEventListener('input', () => {
  renderTable(filteredRows());
});

/* ====== Chart selection per view ====== */
function renderChart(view, rows) {
  if (!rows.length) {
    Plotly.react(chartDiv, [], {paper_bgcolor:'#171a2b', plot_bgcolor:'#171a2b', title:'No data'});
    return;
  }

  const baseLayout = {
    paper_bgcolor:'#171a2b', plot_bgcolor:'#171a2b',
    font:{color:'#e7e9ee'}, margin:{l:50,r:20,t:40,b:50}
  };

  if (view === 'view_top_artists') {
    const x = rows.slice(0,30).map(r => r.artist_norm);
    const y = rows.slice(0,30).map(r => r.parties_appeared_in ?? r.total_tracks);
    Plotly.react(chartDiv, [{type:'bar', x, y}], {...baseLayout, title:'Top Artists by Party Appearances'});
    return;
  }

  if (view === 'view_ritual_tracks') {
    const x = rows.slice(0,30).map(r => `${r.artist_norm} ‚Äî ${r.title_norm}`);
    const y = rows.slice(0,30).map(r => r.appearances);
    Plotly.react(chartDiv, [{type:'bar', x, y}], {...baseLayout, title:'Ritual Tracks (by appearances)'});
    return;
  }

  if (view === 'view_shared_taste') {
    const x = rows.slice(0,30).map(r => `${r.artist_norm} ‚Äî ${r.title_norm}`);
    const y = rows.slice(0,30).map(r => r.different_people);
    Plotly.react(chartDiv, [{type:'bar', x, y}], {...baseLayout, title:'Shared Taste ‚Äî tracks brought by multiple people'});
    return;
  }

  if (view === 'view_personal_variety') {
    const x = rows.map(r => r.person_name || r.person_normalized || r.person_raw);
    const y = rows.map(r => r.unique_tracks);
    Plotly.react(chartDiv, [{type:'bar', x, y}], {...baseLayout, title:'Personal Variety ‚Äî unique tracks per person', xaxis:{tickangle: -30}});
    return;
  }

  if (view === 'view_evolution_by_year') {
    const x = rows.map(r => r.year);
    const y1 = rows.map(r => r.unique_tracks);
    const y2 = rows.map(r => r.unique_artists);
    Plotly.react(chartDiv, [
      {type:'scatter', mode:'lines+markers', x, y:y1, name:'Unique Tracks'},
      {type:'scatter', mode:'lines+markers', x, y:y2, name:'Unique Artists'}
    ], {...baseLayout, title:'Evolution by Year'});
    return;
  }

  if (view === 'view_cycle_comparison') {
    const x = rows.map(r => r.era);
    const y = rows.map(r => r.unique_tracks);
    Plotly.react(chartDiv, [{type:'bar', x, y}], {...baseLayout, title:'Cycle Comparison (Tracks by Era)'});
    return;
  }

  if (view === 'view_influence_summary') {
    const x = rows.map(r => r.influencer);
    const y = rows.map(r => r.total_weighted_influence ?? r.total_influence ?? 0);
    Plotly.react(chartDiv, [{type:'bar', x, y}], {...baseLayout, title:'Influence Summary (time-weighted)', xaxis:{tickangle:-30}});
    return;
  }

  if (view === 'view_influence_edges') {
    // Show as scatter of influencer vs influenced with bubble size = weight
    const x = rows.map(r => r.influencer);
    const y = rows.map(r => r.influenced);
    const s = rows.map(r => (r.weighted_influence ?? r.shared_tracks ?? 1)*8);
    Plotly.react(chartDiv, [{
      type:'scatter', mode:'markers', x, y, marker:{size:s, sizemode:'area'}
    }], {...baseLayout, title:'Influence Edges (bubble = weight)', xaxis:{tickangle:-30}});
    return;
  }

  if (view === 'view_collision_summary') {
    const x = rows.map(r => `${r.person_a} ‚Üî ${r.person_b}`);
    const y = rows.map(r => r.shared_tracks_same_party);
    Plotly.react(chartDiv, [{type:'bar', x, y}], {...baseLayout, title:'Same-Party Collisions (by pair)', xaxis:{tickangle:-30}});
    return;
  }

  if (view === 'view_same_party_collisions') {
    // Show a simple count by party
    const countByParty = {};
    rows.forEach(r => { countByParty[r.party_name] = (countByParty[r.party_name] || 0) + 1;});
    const x = Object.keys(countByParty);
    const y = Object.values(countByParty);
    Plotly.react(chartDiv, [{type:'bar', x, y}], {...baseLayout, title:'Collision intensity by party', xaxis:{tickangle:-30}});
    return;
  }

  // Fallback: just dump columns
  const keys = Object.keys(rows[0]);
  Plotly.react(chartDiv, [{type:'table', header:{values:keys}, cells:{values:keys.map(k => rows.map(r=>r[k]))}}], baseLayout);
}

/* ====== Load + render ====== */
async function loadView() {
  const view = viewSel.value;
  setStatus(`Loading ${view} ‚Ä¶`);
  try {
    rawRows = await fetchAll(view);
    renderTable(filteredRows());
    renderChart(view, filteredRows());
    setStatus(`Loaded ${rawRows.length} rows from ${view}`);
  } catch (err) {
    renderTable([]);
    Plotly.react(chartDiv, [], {paper_bgcolor:'#171a2b', plot_bgcolor:'#171a2b', font:{color:'#e7e9ee'}, title:'Error'});
    setStatus(`‚ùå ${err.message}`);
    console.error(err);
  }
}

function setStatus(msg){
  schemaNote.textContent = msg;
  foot.textContent = `Connected to ${SUPABASE_URL} ¬∑ REST v1 ¬∑ ${new Date().toLocaleString()}`;
}

/* ====== Events ====== */
refreshBtn.onclick = loadView;
viewSel.onchange = loadView;

/* ====== Initial load ====== */
loadView();
</script>
</body>
</html>
