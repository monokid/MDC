<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The MasterDank Collections</title>
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
  :root{
    --bg:#0c0f1a;
    --fg:#f0f2ff;
    --muted:#9ea5c0;
    --card:#151a2d;
    --accent:#8fffd9;
    --glow1:#ff7bf9;
    --glow2:#00ffe1;
    --glow3:#7a8bff;
  }

  html,body{
    margin:0;height:100%;
    background: radial-gradient(circle at 30% 20%, var(--glow1) 0%, transparent 30%),
                radial-gradient(circle at 70% 80%, var(--glow2) 0%, transparent 30%),
                radial-gradient(circle at 50% 50%, var(--bg) 0%, var(--bg) 100%);
    background-size:200% 200%;
    animation:bgmove 18s ease-in-out infinite alternate;
    color:var(--fg);
    font:15px/1.45 "Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Helvetica,Arial,sans-serif;
  }

  @keyframes bgmove {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
  }

  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  h1{font-size:22px;margin:0 0 16px;text-shadow:0 0 12px var(--accent)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  select,input,button{
    background:#1e2340;color:var(--fg);
    border:1px solid #303865;border-radius:10px;
    padding:10px 12px;font:inherit;
  }
  select{min-width:300px}
  button{cursor:pointer;transition:all .2s ease}
  button:hover{background:#282e5a}
  .card{
    background:var(--card);
    border:1px solid rgba(255,255,255,0.08);
    border-radius:16px;
    padding:14px;
    box-shadow:0 0 14px rgba(122,139,255,0.1);
    backdrop-filter:blur(8px);
  }
  #chart{height:480px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px 10px;border-bottom:1px solid #242a4d}
  th{position:sticky;top:0;background:#1b203f;cursor:pointer}
  tr:hover td{background:#1a1f36}
  .muted{color:var(--muted)}
  .pill{
    display:inline-block;padding:3px 8px;
    border-radius:999px;background:#1f2540;
    border:1px solid #2a3054;color:#b8bfd8;font-size:12px
  }
  .footer{margin-top:14px;color:var(--muted);font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <h1>🌀 The MasterDank Collections — <span style="color:var(--accent)">Session Explorer</span></h1>
  <div class="row">
    <label for="viewSel">View</label>
    <select id="viewSel">
      <option value="view_top_artists">view_top_artists</option>
      <option value="view_ritual_tracks">view_ritual_tracks</option>
      <option value="view_shared_taste">view_shared_taste</option>
      <option value="view_personal_variety">view_personal_variety</option>
      <option value="view_evolution_by_year">view_evolution_by_year</option>
      <option value="view_cycle_comparison">view_cycle_comparison</option>
      <option value="view_influence_summary">view_influence_summary</option>
      <option value="view_influence_edges">view_influence_edges</option>
      <option value="view_collision_summary">view_collision_summary</option>
      <option value="view_same_party_collisions">view_same_party_collisions</option>
    </select>

    <label for="searchBox">Search</label>
    <input id="searchBox" type="search" placeholder="filter table (client-side)"/>
    <button id="refreshBtn">Refresh</button>
    <span class="pill" id="rowCount">0 rows</span>
  </div>

  <div class="card" id="chart"></div>

  <div class="card">
    <div class="muted" id="schemaNote"></div>
    <div style="overflow:auto;max-height:420px;margin-top:10px">
      <table id="dataTable"><thead></thead><tbody></tbody></table>
    </div>
    <div class="footer" id="foot"></div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://ilvfgrahrejymvnyrrxa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdmZncmFocmVqeW12bnlycnhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODY4MzgsImV4cCI6MjA3NjE2MjgzOH0.BF9-ohNBCXhJUBvC0t6rtI8V9LcmL7PbfSKt_M4Mu0s";

const viewSel=document.getElementById('viewSel'),
refreshBtn=document.getElementById('refreshBtn'),
tbl=document.getElementById('dataTable'),
thead=tbl.querySelector('thead'),
tbody=tbl.querySelector('tbody'),
chartDiv=document.getElementById('chart'),
searchBox=document.getElementById('searchBox'),
rowCount=document.getElementById('rowCount'),
schemaNote=document.getElementById('schemaNote'),
foot=document.getElementById('foot');

let rawRows=[];

function primaryOrderHint(table){
  switch(table){
    case 'view_top_artists': return 'parties_appeared_in.desc';
    case 'view_ritual_tracks': return 'appearances.desc';
    case 'view_influence_summary': return 'total_weighted_influence.desc';
    default: return '';
  }
}

async function fetchAll(table){
  const rows=[], base=`${SUPABASE_URL}/rest/v1/${encodeURIComponent(table)}`;
  let from=0, step=1000, more=true;
  const order=primaryOrderHint(table);
  while(more){
    const to=from+step-1;
    const url=`${base}?select=*${order?`&order=${order}`:''}`;
    const res=await fetch(url,{
      headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`,Range:`${from}-${to}`,Prefer:'count=estimated'}
    });
    if(!res.ok){throw new Error(`HTTP ${res.status}: ${await res.text()}`);}
    const chunk=await res.json();
    rows.push(...chunk);
    more=chunk.length===step;from+=step;
  }
  return rows;
}

function renderTable(rows){
  if(!rows.length){thead.innerHTML="<tr><th>No data</th></tr>";tbody.innerHTML="";rowCount.textContent="0 rows";return;}
  const cols=Object.keys(rows[0]);
  thead.innerHTML="<tr>"+cols.map(c=>`<th data-col="${c}">${c}</th>`).join("")+"</tr>";
  tbody.innerHTML=rows.map(r=>"<tr>"+cols.map(c=>`<td>${escapeCell(r[c])}</td>`).join("")+"</tr>").join("");
  rowCount.textContent=`${rows.length} rows`;
  [...thead.querySelectorAll('th')].forEach(th=>{
    th.onclick=()=>{
      const col=th.dataset.col;
      const isNum=rows.every(x=>x[col]==null||typeof x[col]==='number');
      const current=th.dataset.dir==='asc'?'desc':'asc';
      thead.querySelectorAll('th').forEach(t=>t.removeAttribute('data-dir'));
      th.setAttribute('data-dir',current);
      rawRows.sort((a,b)=>{
        const A=a[col],B=b[col];
        if(A==null&&B==null)return 0;
        if(A==null)return 1;
        if(B==null)return -1;
        return isNum?(current==='asc'?A-B:B-A):(current==='asc'?String(A).localeCompare(String(B)):String(B).localeCompare(String(A)));
      });
      renderTable(filteredRows());
    };
  });
}

function escapeCell(v){if(v==null)return"";if(typeof v==='object')return JSON.stringify(v);return String(v).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}
function filteredRows(){const q=searchBox.value.trim().toLowerCase();if(!q)return rawRows;return rawRows.filter(row=>Object.values(row).some(v=>v!=null&&String(v).toLowerCase().includes(q)));}

searchBox.addEventListener('input',()=>renderTable(filteredRows()));

function renderChart(view,rows){
  const baseLayout={paper_bgcolor:'#151a2d',plot_bgcolor:'#151a2d',font:{color:'#f0f2ff'},margin:{l:50,r:20,t:40,b:50}};
  if(!rows.length){Plotly.react(chartDiv,[],{...baseLayout,title:'No data'});return;}
  if(view==='view_top_artists'){Plotly.react(chartDiv,[{type:'bar',x:rows.slice(0,30).map(r=>r.artist_norm),y:rows.slice(0,30).map(r=>r.parties_appeared_in??r.total_tracks),marker:{color:'var(--accent)'}}],{...baseLayout,title:'Top Artists'});return;}
  if(view==='view_ritual_tracks'){Plotly.react(chartDiv,[{type:'bar',x:rows.slice(0,30).map(r=>`${r.artist_norm} — ${r.title_norm}`),y:rows.slice(0,30).map(r=>r.appearances)}],{...baseLayout,title:'Ritual Tracks'});return;}
  if(view==='view_shared_taste'){Plotly.react(chartDiv,[{type:'bar',x:rows.slice(0,30).map(r=>`${r.artist_norm} — ${r.title_norm}`),y:rows.slice(0,30).map(r=>r.different_people)}],{...baseLayout,title:'Shared Taste'});return;}
  if(view==='view_personal_variety'){Plotly.react(chartDiv,[{type:'bar',x:rows.map(r=>r.person_name||r.person_normalized||r.person_raw),y:rows.map(r=>r.unique_tracks)}],{...baseLayout,title:'Personal Variety',xaxis:{tickangle:-30}});return;}
  if(view==='view_evolution_by_year'){const x=rows.map(r=>r.year),y1=rows.map(r=>r.unique_tracks),y2=rows.map(r=>r.unique_artists);Plotly.react(chartDiv,[{type:'scatter',mode:'lines+markers',x,y:y1,name:'Tracks'},{type:'scatter',mode:'lines+markers',x,y:y2,name:'Artists'}],{...baseLayout,title:'Evolution by Year'});return;}
  if(view==='view_cycle_comparison'){Plotly.react(chartDiv,[{type:'bar',x:rows.map(r=>r.era),y:rows.map(r=>r.unique_tracks)}],{...baseLayout,title:'Cycle Comparison'});return;}
  if(view==='view_influence_summary'){Plotly.react(chartDiv,[{type:'bar',x:rows.map(r=>r.influencer),y:rows.map(r=>r.total_weighted_influence??r.total_influence??0)}],{...baseLayout,title:'Influence Summary',xaxis:{tickangle:-30}});return;}
  if(view==='view_influence_edges'){Plotly.react(chartDiv,[{type:'scatter',mode:'markers',x:rows.map(r=>r.influencer),y:rows.map(r=>r.influenced),marker:{size:rows.map(r=>(r.weighted_influence??r.shared_tracks??1)*8,sizemode:'area')}}],{...baseLayout,title:'Influence Edges'});return;}
  if(view==='view_collision_summary'){Plotly.react(chartDiv,[{type:'bar',x:rows.map(r=>`${r.person_a} ↔ ${r.person_b}`),y:rows.map(r=>r.shared_tracks_same_party)}],{...baseLayout,title:'Same-Party Collisions'});return;}
  if(view==='view_same_party_collisions'){const countByParty={};rows.forEach(r=>{countByParty[r.party_name]=(countByParty[r.party_name]||0)+1;});Plotly.react(chartDiv,[{type:'bar',x:Object.keys(countByParty),y:Object.values(countByParty)}],{...baseLayout,title:'Collision Intensity by Party'});return;}
  const keys=Object.keys(rows[0]);Plotly.react(chartDiv,[{type:'table',header:{values:keys},cells:{values:keys.map(k=>rows.map(r=>r[k]))}}],baseLayout);
}

async function loadView(){
  const view=viewSel.value;
  setStatus(`Loading ${view} …`);
  try{
    rawRows=await fetchAll(view);
    renderTable(filteredRows());
    renderChart(view,filteredRows());
    setStatus(`Loaded ${rawRows.length} rows from ${view}`);
  }catch(err){
    renderTable([]);Plotly.react(chartDiv,[],{paper_bgcolor:'#151a2d',plot_bgcolor:'#151a2d',font:{color:'#f0f2ff'},title:'Error'});setStatus(`❌ ${err.message}`);console.error(err);
  }
}

function setStatus(msg){
  schemaNote.textContent=msg;
  foot.textContent=`Connected to ${SUPABASE_URL} · REST v1 · ${new Date().toLocaleString()}`;
}

refreshBtn.onclick=loadView;viewSel.onchange=loadView;loadView();
</script>
</body>
</html>
