<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The MasterDank Collections — Track Search</title>
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(120deg, #0a0f2c, #001f3f, #170f2e);
      background-size: 400% 400%;
      animation: bgShift 30s ease infinite;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    @keyframes bgShift {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }
    header {
      padding: 1.5rem;
      font-size: 1.6rem;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 2px solid #0ff;
      text-shadow: 0 0 8px #0ff;
    }
    .container {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0,255,255,0.2);
    }
    input, select, button {
      font-family: 'Orbitron', sans-serif;
      font-size: 1rem;
      padding: 0.5rem;
      border: none;
      border-radius: 6px;
      margin: 0.3rem;
      color: #fff;
      background: rgba(0,0,0,0.6);
      outline: none;
    }
    button {
      background: #00ffff;
      color: #000;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    button:hover {
      background: #00b3b3;
    }
    table {
      margin: 1rem auto;
      border-collapse: collapse;
      width: 100%;
      color: #fff;
      display: none;
    }
    th, td {
      border: 1px solid rgba(255,255,255,0.1);
      padding: 0.5rem;
      text-align: left;
      cursor: pointer;
    }
    th {
      background: rgba(0,255,255,0.1);
    }
    tr:hover {
      background: rgba(0,255,255,0.05);
    }
    #status {
      margin-top: 1rem;
      color: #f66;
      font-size: 0.9rem;
    }
    footer {
      font-size: 0.8rem;
      color: #aaa;
      margin-top: 2rem;
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal-content {
      background: rgba(0, 10, 20, 0.95);
      border: 2px solid #0ff;
      border-radius: 12px;
      padding: 2rem;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 0 40px rgba(0,255,255,0.3);
      text-align: left;
      position: relative;
      animation: popIn 0.3s ease;
    }
    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal h2 {
      margin-top: 0;
      color: #0ff;
      text-shadow: 0 0 10px #0ff;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      color: #0ff;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .close:hover {
      color: #f66;
    }
    .modal pre {
      background: rgba(0,255,255,0.05);
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <header>🧠 The MasterDank Collections — <span style="color:#00ffaa;">Track Search</span></header>

  <div class="container">
    <div>
      <input type="text" id="query" placeholder="Search by track or artist..." size="40">
      <select id="personFilter"><option value="">All bringers</option></select>
      <select id="partyFilter"><option value="">All sessions</option></select>
      <select id="sortBy">
        <option value="file_name.asc">Sort: Name ↑</option>
        <option value="file_name.desc">Sort: Name ↓</option>
        <option value="artist_norm.asc">Sort: Artist ↑</option>
        <option value="artist_norm.desc">Sort: Artist ↓</option>
        <option value="party_name.asc">Sort: Session ↑</option>
        <option value="party_name.desc">Sort: Session ↓</option>
      </select>
      <button onclick="searchTracks()">Search</button>
      <button onclick="exportCSV()">Export CSV</button>
    </div>
    <div id="status"></div>

    <table id="results">
      <thead>
        <tr>
          <th>Track</th>
          <th>Artist</th>
          <th>Sessions</th>
          <th>Brought by</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <footer>✨ Powered by Supabase — handcrafted by The MasterDank Crew ✨</footer>
  </div>

  <div id="trackModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">Track Details</h2>
      <div id="modalBody"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabaseUrl = 'https://ilvfgrahrejymvnyrrxa.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdmZncmFocmVqeW12bnlycnhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODY4MzgsImV4cCI6MjA3NjE2MjgzOH0.BF9-ohNBCXhJUBvC0t6rtI8V9LcmL7PbfSKt_M4Mu0s';
    const supabase = createClient(supabaseUrl, supabaseKey);

    let lastResults = [];

    async function loadFilters() {
      const { data: persons } = await supabase.from('tracks_v2').select('person_raw').not('person_raw', 'is', null);
      const { data: parties } = await supabase.from('tracks_v2').select('party_name').not('party_name', 'is', null);

      const personSet = new Set(persons?.map(p => p.person_raw).filter(Boolean));
      const partySet = new Set(parties?.map(p => p.party_name).filter(Boolean));

      const personSelect = document.getElementById('personFilter');
      const partySelect = document.getElementById('partyFilter');

      for (const val of [...personSet].sort()) {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        personSelect.appendChild(opt);
      }

      for (const val of [...partySet].sort()) {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        partySelect.appendChild(opt);
      }
    }

    async function searchTracks() {
  const query = document.getElementById('query').value.trim();
  const person = document.getElementById('personFilter').value;
  const party = document.getElementById('partyFilter').value;
  const sortBy = document.getElementById('sortBy').value;
  const status = document.getElementById('status');
  const table = document.getElementById('results');
  const tbody = table.querySelector('tbody');

  tbody.innerHTML = '';
  table.style.display = 'none';
  status.textContent = '🔍 Searching...';
  status.style.color = '#fff';

  try {
    const keywords = query ? query.split(/\s+/).filter(Boolean) : [];

    let q = supabase.from('tracks_v2').select('*');
    const [col, dir] = sortBy.split('.');
    q = q.order(col, { ascending: dir === 'asc' });

    if (person) q = q.eq('person_raw', person);
    if (party) q = q.eq('party_name', party);

    // If no keywords, just run base query
    if (keywords.length === 0) {
      q = q.limit(300);
      const { data, error } = await q;
      if (error) throw error;
      renderResults(data, status, table, tbody);
      return;
    }

    // Start with first keyword
    const word = keywords[0];
    q = q.or(`artist_norm.ilike.%${word}%,title_norm.ilike.%${word}%,file_name.ilike.%${word}%`);

    // Run first search
    const { data: initialData, error: firstError } = await q;
    if (firstError) throw firstError;
    let filtered = initialData || [];

    // Apply additional keywords client-side for AND logic
    if (keywords.length > 1) {
      filtered = filtered.filter(row =>
        keywords.every(kw =>
          [row.artist_norm, row.title_norm, row.file_name]
            .some(field => (field || '').toLowerCase().includes(kw.toLowerCase()))
        )
      );
    }

    renderResults(filtered, status, table, tbody);
  } catch (err) {
    console.error('Search error:', err);
    status.textContent = 'Error performing search.';
    status.style.color = '#f66';
  }
}

// Helper function to render results
function renderResults(data, status, table, tbody) {
  if (!data || data.length === 0) {
    status.textContent = 'No results found.';
    return;
  }

  const seen = new Set();
  const unique = data.filter(r => {
    if (seen.has(r.sha1)) return false;
    seen.add(r.sha1);
    return true;
  });

  lastResults = unique;
  table.style.display = 'table';
  status.textContent = `🎶 Found ${unique.length} results.`;
  status.style.color = '#0f0';

  for (const row of unique) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.title_norm || row.file_name}</td>
      <td>${row.artist_norm || 'Unknown'}</td>
      <td>${row.party_name || '-'}</td>
      <td>${row.person_raw || '-'}</td>
    `;
    tr.addEventListener('click', () => showDetails(row));
    tbody.appendChild(tr);
  }
}

    function showDetails(row) {
      const modal = document.getElementById('trackModal');
      const body = document.getElementById('modalBody');
      const title = document.getElementById('modalTitle');

      title.textContent = row.title_norm || row.file_name;

      body.innerHTML = `
        <p><strong>Artist:</strong> ${row.artist_norm || 'Unknown'}</p>
        <p><strong>Party:</strong> ${row.party_name || '-'}</p>
        <p><strong>Brought by:</strong> ${row.person_raw || '-'}</p>
        <p><strong>File:</strong> ${row.file_name}</p>
        <p><strong>Size:</strong> ${row.size_kb} KB</p>
        <p><strong>SHA1:</strong> <code>${row.sha1}</code></p>
        <p><strong>Full Path:</strong></p>
        <pre>${row.fullpath}</pre>
        <p><strong>Added at:</strong> ${new Date(row.added_at).toLocaleString()}</p>
      `;

      modal.style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('trackModal').style.display = 'none';
    }

    window.onclick = (e) => {
      if (e.target === document.getElementById('trackModal')) closeModal();
    };

    function exportCSV() {
      if (!lastResults.length) {
        alert('No data to export.');
        return;
      }

      const header = Object.keys(lastResults[0]);
      const csvRows = [header.join(';')];

      for (const row of lastResults) {
        csvRows.push(header.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(';'));
      }

      const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `MasterDank_Export_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    loadFilters();
    window.searchTracks = searchTracks;
    window.exportCSV = exportCSV;
    window.closeModal = closeModal;
  </script>
</body>
</html>

