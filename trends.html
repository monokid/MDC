<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The MasterDank Collections ‚Äî Analytics Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(120deg, #0a0f2c, #001f3f, #170f2e);
      background-size: 400% 400%;
      animation: bgShift 40s ease infinite;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    @keyframes bgShift {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }
    header {
      font-size: 1.6rem;
      padding: 1.2rem;
      text-align: center;
      background: rgba(0,0,0,0.3);
      border-bottom: 2px solid #00ffaa;
      text-shadow: 0 0 8px #00ffaa;
    }
    a {
      color: #00ffaa;
      text-decoration: none;
      transition: 0.2s;
    }
    a:hover { color: #fff; }

    .kpi-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1.2rem;
      padding: 1.5rem;
    }
    .kpi {
      background: rgba(0,0,0,0.4);
      border: 1px solid #00ffaa;
      border-radius: 10px;
      padding: 1rem 1.5rem;
      width: 180px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0,255,170,0.2);
      transition: transform 0.2s ease;
    }
    .kpi:hover { transform: scale(1.05); }
    .kpi h3 {
      margin: 0;
      font-size: 1rem;
      color: #00ffaa;
    }
    .kpi p {
      font-size: 1.4rem;
      margin: 0.3rem 0 0;
      font-weight: bold;
      color: #fff;
    }

    .chart-container, .table-container {
      width: 90%;
      max-width: 1000px;
      margin: 2rem auto;
      padding: 1rem;
      background: rgba(0,0,0,0.4);
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0,255,255,0.2);
    }
    h2 {
      color: #00ffaa;
      text-align: center;
      text-shadow: 0 0 10px #00ffaa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: #fff;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      text-align: left;
    }
    th {
      color: #00ffaa;
      background: rgba(0,255,255,0.1);
    }
    tbody tr:hover {
      background: rgba(0,255,255,0.1);
    }
    footer {
      font-size: 0.8rem;
      color: #aaa;
      text-align: center;
      margin: 2rem 0;
    }
  </style>
</head>
<body>
  <header>
    üåà The MasterDank Collections ‚Äî <span style="color:#00ffaa;">Analytics Dashboard</span><br>
    <a href="home.html">‚Üê Back to Search</a>
  </header>

  <section class="kpi-grid">
    <div class="kpi"><h3>Total Tracks</h3><p id="kpi-tracks">‚Äî</p></div>
    <div class="kpi"><h3>Unique Tracks</h3><p id="kpi-unique">‚Äî</p></div>
    <div class="kpi"><h3>Artists</h3><p id="kpi-artists">‚Äî</p></div>
    <div class="kpi"><h3>Sessions</h3><p id="kpi-sessions">‚Äî</p></div>
    <div class="kpi"><h3>Bringers</h3><p id="kpi-bringers">‚Äî</p></div>
  </section>

  <div class="chart-container">
    <h2>üé§ Top 10 Artists</h2>
    <div id="topArtists"></div>
  </div>

  <div class="chart-container">
    <h2>üé∂ Top 10 Songs</h2>
    <div id="topSongs"></div>
  </div>

  <div class="table-container">
    <h2>üìÄ Songs per Session</h2>
    <table id="table-sessions"><thead><tr><th>Session</th><th>Tracks</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="table-container">
    <h2>üßç‚Äç‚ôÇÔ∏è Songs per Bringer</h2>
    <table id="table-bringers"><thead><tr><th>Bringer</th><th>Tracks</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="table-container">
    <h2>üí• Collisions (Same Track / Artist in Multiple Sessions)</h2>
    <table id="table-collisions"><thead><tr><th>Track</th><th>Artist</th><th>Sessions</th><th>Bringers</th></tr></thead><tbody></tbody></table>
  </div>

  <footer>‚ú® Powered by Supabase + Plotly ‚Äî handcrafted by The MasterDank Crew ‚ú®</footer>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(
      'https://ilvfgrahrejymvnyrrxa.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsdmZncmFocmVqeW12bnlycnhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODY4MzgsImV4cCI6MjA3NjE2MjgzOH0.BF9-ohNBCXhJUBvC0t6rtI8V9LcmL7PbfSKt_M4Mu0s'
    );

    async function loadData() {
      const { data, error } = await supabase.from('tracks_v2').select('*');
      if (error) {
        console.error(error);
        return;
      }

      // === KPI SECTION ===
      const totalTracks = data.length;
      const uniqueTracks = new Set(data.map(t => t.sha1)).size;
      const uniqueArtists = new Set(data.map(t => t.artist_norm?.toLowerCase()).filter(Boolean)).size;
      const uniqueSessions = new Set(data.map(t => t.party_name?.toLowerCase()).filter(Boolean)).size;
      const uniqueBringers = new Set(data.map(t => t.person_raw?.toLowerCase()).filter(Boolean)).size;

      document.getElementById('kpi-tracks').textContent = totalTracks;
      document.getElementById('kpi-unique').textContent = uniqueTracks;
      document.getElementById('kpi-artists').textContent = uniqueArtists;
      document.getElementById('kpi-sessions').textContent = uniqueSessions;
      document.getElementById('kpi-bringers').textContent = uniqueBringers;

      // === CHARTS ===
      const artistCount = {};
      const songCount = {};
      const sessionCount = {};
      const bringerCount = {};
      const collisions = {};

      for (const row of data) {
        const artist = (row.artist_norm || 'Unknown').trim();
        const song = (row.title_norm || row.file_name || 'Unknown').trim();
        const session = (row.party_name || 'Unknown').trim();
        const bringer = (row.person_raw || 'Unknown').trim();
        const id = row.sha1;

        artistCount[artist] = (artistCount[artist] || 0) + 1;
        songCount[song] = (songCount[song] || 0) + 1;
        sessionCount[session] = (sessionCount[session] || 0) + 1;
        bringerCount[bringer] = (bringerCount[bringer] || 0) + 1;

        // collisions: same sha1, multiple sessions or bringers
        if (!collisions[id]) collisions[id] = { track: song, artist, sessions: new Set(), bringers: new Set() };
        collisions[id].sessions.add(session);
        collisions[id].bringers.add(bringer);
      }

      // Plot top 10 artists
      const sortedArtists = Object.entries(artistCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
      Plotly.newPlot('topArtists', [{
        x: sortedArtists.map(a=>a[0]),
        y: sortedArtists.map(a=>a[1]),
        type: 'bar',
        marker: {color:'rgba(0,255,255,0.8)'}
      }], {paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#fff'}});

      // Plot top 10 songs
      const sortedSongs = Object.entries(songCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
      Plotly.newPlot('topSongs', [{
        x: sortedSongs.map(a=>a[0]),
        y: sortedSongs.map(a=>a[1]),
        type: 'bar',
        marker: {color:'rgba(255,0,255,0.8)'}
      }], {paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:'#fff'}});

      // === TABLES ===
      const tbodySessions = document.querySelector('#table-sessions tbody');
      const tbodyBringers = document.querySelector('#table-bringers tbody');
      const tbodyCollisions = document.querySelector('#table-collisions tbody');

      const sortedSessions = Object.entries(sessionCount).sort((a,b)=>b[1]-a[1]);
      for (const [session, count] of sortedSessions)
        tbodySessions.innerHTML += `<tr><td>${session}</td><td>${count}</td></tr>`;

      const sortedBringers = Object.entries(bringerCount).sort((a,b)=>b[1]-a[1]);
      for (const [bringer, count] of sortedBringers)
        tbodyBringers.innerHTML += `<tr><td>${bringer}</td><td>${count}</td></tr>`;

      const collisionRows = Object.values(collisions).filter(c=>c.sessions.size>1 || c.bringers.size>1);
      for (const c of collisionRows) {
        tbodyCollisions.innerHTML += `
          <tr>
            <td>${c.track}</td>
            <td>${c.artist}</td>
            <td>${Array.from(c.sessions).join(', ')}</td>
            <td>${Array.from(c.bringers).join(', ')}</td>
          </tr>`;
      }
    }

    loadData();
  </script>
</body>
</html>
